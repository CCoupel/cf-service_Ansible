---
- name: bootstrap VMs
  hosts: 127.0.0.1
  connection: local
  gather_facts: false
  tasks:
          - name: debug vars
            debug: 
              msg: "ansible_inventory={{ ansible_inventory }} ansible_groups={{ ansible_groups }} test_var={{ test_var }}"
          
          - name: test
            debug: 
              msg: "item={{ item[0] }}"
            with_items:
            - "{{ ansible_inventory }}"

          - name: make inventory
            add_host: 
              name: "{{ item.0 }}"
              group: "{{ item.1 }}"
              ansible_ssh_host: "{{ item.2 }}"
            with_items:
            - "{{ ansible_inventory }}"

            - name: debug groups
              debug: 
              msg: "{{ groups }}"

- name: bootstrap Groups
  hosts: 127.0.0.1
  connection: local
  gather_facts: false
  tasks:
          - name: debug vars
            debug: 
              msg: "groups={{ ansible_groups }}"
          
          - name: test
            debug: 
              msg: "item.0={{ item.0 }} item.1={{ item.1 }}"
            with_items:
            - "{{ ansible_inventory }}"

          - name: make groups
            group_by: 
              key: "{{ item.0 }}"
              parent: "{{ item.1 }}"
            with_items:
            - "{{ ansible_inventory }}"

            - name: debug groups
              debug: 
              msg: "{{ groups }}"
